---
title: "ST 558 Project 1"
author: "Jarrett Glass, Shohn Godboldt"
format: html
editor: visual
---

```{r}
#| echo: FALSE
library(tidyverse)
```

# Introduction to the PUMS API

The United States Census Bureau, operating under Titles 13 and 26 of the U.S. Code, are charged with collecting demographic information about people and families living in the US. They are dedicated to providing quality data, which is crucial as they are used for vital tasks such as

:::: {.callout-note appearance="simple" icon="false"}
Determining the distribution of Congressional seats to states;

-   Making planning decisions about community services;
-   Informing how trillions of dollars in federal funds are distributed to local, state, and tribal governments each year;
-   Providing Age Search information (Social Security, Passports, estate resolutions, etc.)

::: {style="font-size:0.9em;font-style:italic;color:#555;margin-top:0.5em;"}
Source: https://www.census.gov/about/what.html
:::
::::

The US Census Bureau has maintained a public Application Programming Interface (API) since 2012 to allow users to send queries to their databases. The API, called the `Public Use Microdata Sample (PUMS)` API, is accessible by using a specific URL, which need be constructed to contain all the elements of the query. In this instance, the API is the **Public Use Microdata Sample** (PUMS) API, which utilizes data collected from the **American Community Survey** (ACS).

As stated, the specific variables and terms in the URL used are what define the query and state the terms of the request. The structure of this is:

+--------------------+---------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Element            | Code Example                                      | Use                                                                                                                                                                                |
+====================+===================================================+====================================================================================================================================================================================+
| Root URL           | `https://api.census.gov/data/2022/acs/acs1/pums?` | Root address for where the queries should be addressed, and the primary target of the `GET()` request. This specifically targets\                                                  |
|                    |                                                   | 1) data from 2022,\                                                                                                                                                                |
|                    |                                                   | 2) their ACS data set, and\                                                                                                                                                        |
|                    |                                                   | 3) more specifically the 1-year ACS estimates.                                                                                                                                     |
+--------------------+---------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Query parameters   | `get=VAR1,VAR2,VAR3`                              | `get` specifies the specific variables for which we wish to receive data.                                                                                                          |
|                    |                                                   |                                                                                                                                                                                    |
|                    | `for=state:01,02,03`                              | `for` specifies the geographic area, where region, division, or state names are represented by numeric codes.                                                                      |
|                    |                                                   |                                                                                                                                                                                    |
|                    | `tabulate=weight(VAR1)`\                          | `tabulate` is an *alternative* to `get`, and would perform aggregation on raw data and return a table of statistics. This parameter is not reviewed or evaluated in this exercise. |
+--------------------+---------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Additional Filters | `&VAR=Value`                                      | Any other additional filters that would allow a user to refine the search further and create more specificity.                                                                     |
+--------------------+---------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

: Structure of PUMS API query URL

Our goal is to write a function that will query this PUMS API for a selection of variables and perform some manipulations and processing of the resulting data sets.

## Establishing the Query Function

We need to construction a function to query the API \[use the `GET()` function from `library(httr)`\]. A helper function will be needed to take what is returned by `get` to turn it into a "nice `tibble`".

This will be a function to query the API that allows the user to specify:

-   Year of survey (default is 2022; must be a valid value between 2010 and 2022).

-   The numeric variables that could be queried for are:

    -   `PWGTP` - PUMS `person` weight, indicating the number of people that a single "person" record could "speak" for. (This variable must be included, and can not be removed by the user.)

    -   `AGEP` - Person age (default value along with `PWGTP`, but this one can be changed)

    -   `GASP` - The cost of gas for housing during the 12-month period reviewed.

    -   `GRPIP` - Gross Rent as a Percentage of household Income

    -   `JWDP (time)` - Time of **departure** for work.

    -   `JWAP (time)` - Time of **arrival** at work.

    -   `JWMNP` - The number of minutes spent commuting to work.

-   The categorical variables that could be queried for are:

    -   `SEX` - This was intended to refer to *biological* sex of the survey responder, but this survey is self-reporting and voluntary. This is to be the default categorical variable, and multiple can be selected.

    -   `FER` - Refers to "fertility", an indicator variable for whether a woman has given birth within the previous 12 months from the survey. This is only valid for women aged 15 to 50.

    -   `HHL` - The household language.

    -   `HISPEED` - Indicates if the residence has high-speed internet (fiber optic, DSL, etc.)

    -   `JWTRNS` - The primary means of transportation to go to work.

    -   `SCH` - School enrollment, this indicates whether a person is currently enrolled in school; and what level they may be in.

    -   `SCHL` - The level of degree/schooling a person has received.

-   The geographic levels (`All`, `Region`, `Division`, `State`) should be specified.

-   Any numeric, categorical, or geographic levels not specified above will be disregarded.

## Obtaining Person Level Records

Process the data in the tibble appropriately. Variable `PWGTP` represents the number of people/observations for a particular row.

## Writing generic function for summarizing

A `summary` function has been created to take our `census` objects and provide some statistical information. 

The function was created in a way that took up to three variables:

1.  The `census` item generated in the function above;

2.  (OPTIONAL) A vector or single item with keyword `numerics=` which will contain the **numeric** variables selected. An error is generated if the keyword `numerics=` is used with a categorical column.
    
+ Note: The `PWGTP` variable is not returned by default. This must be specifically requested in `numerics=` in order to call it.

3.  (OPTIONAL) A vector or single item with the keyword `categoricals=` which will contain the **categorical** variables selected. An error is generated in the keyword `categoricals=` is used with a numeric column.

The summary statistics returned will be the mean and standard deviation for each numeric variable, and the counts of each factor for categorical variables. These are returned as named lists, which are convenient for assigning to a variable and calling specific items. 

```{r}
summary.census <- function(object, ...) {
  
  args <- list(...)
  
  # Stop if any keywords are included that are not `numerics` or `categoricals`
  if (length(setdiff(names(args), c("numerics", "categoricals")))) {
    stop("Keyword error: keywords must be `numerics=` or `categoricals=` to specify column summary request.")
  }
  
  # If `numerics` are provided, confirm they are actually numeric variables:
  if ("numerics" %in% names(args)) {
    if (!all(sapply(object[args$numerics], is.numeric))) {
      stop("Selected numeric variables should all be numeric.")
    } else { numerics <- args$numerics }
  } else {
    numerics <- names(select(object, where(is.numeric)))
    # Unless it's specified, do not return PWGTP variable.    
    numerics <- numerics[!numerics %in% "PWGTP"]
  }
  
  # If `categoricals` are provided, confirm they're actually factors:
  if ("categoricals" %in% names(args)) {
    if (!all(sapply(object[args$categoricals], is.factor))) {
      stop("Selected categorical variables should all be factors.")
    } else { categoricals <- args$categoricals }
  } else categoricals <- names(select(object, where(is.factor)))
  
  # Reduce the input `object` to its selected variables.
  object <- object |> select(numerics, categoricals)
  
  # Function to produce `summary` reporting for census object
  report <- function(obj) {
    # Numeric variables: return a named list with `mean` and `sigma`
    if (class(obj) == "numeric") list(mean=mean(obj), sigma=sd(obj))
    # Categorical variables: return unique factors and their counts.
    else if (class(obj) == "factor") table(obj)
    # Fail if object class is neither numeric nor factor.
    else stop("Improper class passed to report function.")
  }
  lapply(as.list(object), FUN=report)
}

# THIS IS JUST TO SHOW THAT IT WORKS. Show some examples using the function created here.
example <- iris
class(example) <- c("census", class(iris))
summary(example)
```

## Plot function

Similar to the `summary` adaptation above, a `plot` adaptation is also generated for `census` objects. This is designed to require a single categorical variable and a single numerical variable, as strings. The usage for this command is

```plot(object, categorical="[Categorical Var]", numerical="[Numerical Variable]")```

where *[Categorical Var]* and *[Numerical Var]* are substitued with the names of the desired columns of their requisite classes.

```{r}
# Run plot() on a `census` object.

plot.census <- function(object, categorical, numerical, ...) {
  args = list(...) # Look at possibly adding options for customization. Add a title, for instance?
  ggplot(object,
         aes(x=get(categorical), y=get(numerical), weight=PWGTP)) +
    geom_boxplot()
}
```